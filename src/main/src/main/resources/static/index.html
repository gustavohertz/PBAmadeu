<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Func. - Listagem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="py-4">
<div class="container">
    <h1 class="mb-3">Funcionários (Vindo do Java)</h1>
    <div class="mb-3">
        <a href="form.html" class="btn btn-primary">Novo Funcionário</a>
    </div>

    <table id="tabela" class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Salário</th>
            <th>Ações</th>
        </tr>
        </thead>
        <tbody id="lista">
        </tbody>
    </table>

    <div id="loading" class="text-center text-muted">Carregando dados do servidor...</div>
</div>

<script>
    const API_URL = 'http://localhost:8080/funcionarios';

    // Função principal que carrega a lista
    async function loadList() {
        const lista = document.getElementById('lista');
        const loading = document.getElementById('loading');
        lista.innerHTML = ''; // Limpa a tabela antes de recarregar

        try {
            // 1. Faz a chamada para o Java (GET)
            const response = await fetch(API_URL);

            if (!response.ok) {
                throw new Error("Erro ao conectar com servidor");
            }

            // 2. Converte a resposta em JSON
            const dados = await response.json();

            loading.style.display = 'none'; // Esconde mensagem de carregando

            if (dados.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum funcionário cadastrado no Backend.</td></tr>';
                return;
            }

            // 3. Para cada funcionário, cria uma linha na tabela
            dados.forEach(f => {
                const tr = document.createElement('tr');
                // Formata o salário para dinheiro
                const salarioFormatado = f.salario.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                tr.innerHTML = `
                    <td>${f.id}</td>
                    <td>${f.nome}</td>
                    <td>${f.cpf}</td>
                    <td>${salarioFormatado}</td>
                    <td>
                        <button onclick="excluir(${f.id})" class="btn btn-sm btn-outline-danger">Excluir</button>
                    </td>
                `;
                lista.appendChild(tr);
            });

        } catch (error) {
            console.error(error);
            loading.innerHTML = `<span class="text-danger">Erro: Não foi possível conectar ao Java (Porta 8080). O servidor está rodando?</span>`;
        }
    }

    // Função para excluir (bônus)
    async function excluir(id) {
        if (confirm('Confirma exclusão do ID ' + id + '?')) {
            try {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                loadList(); // Recarrega a tabela
            } catch (e) {
                alert('Erro ao excluir');
            }
        }
    }

    // Carrega a lista assim que a página abre
    window.addEventListener('load', loadList);
</script>
</body>
</html>